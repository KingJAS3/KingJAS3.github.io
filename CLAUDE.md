# Defense Budget Explorer — CLAUDE.md

Reference document for future AI sessions. Describes the project structure, data schemas,
parser behavior, and key architectural decisions.

---

## Project Overview

A React + Vite dashboard that visualizes DoD FY2026 J-Book (budget justification) data.
Hosted on GitHub Pages at `kingjas3.github.io` (user site → `base: "/"` in vite.config.js).

**Data sources downloaded:** Defense-Wide (JSON) and DoD Summary (Excel + JSON).
**Not available:** Army and Air Force/Space Force portals return HTTP 403 to automated requests
despite browser-like User-Agent headers. Navy publishes PDF-only. Future sessions may need
to add manual download steps.

---

## File Structure

```
fy2026_budget/          raw downloaded files (NOT committed — too large)
  DefenseWide/
    O&M/                volume-level JSON compilations (18MB each)
    O&M_Agencies/       individual agency OP-5 exhibits (CYBERCOM, DISA, DLA, etc.)
    BRAC/               XML (PDF-derived, no structured data)
  DoD_Summary/
    *.xlsx              P-1, R-1, M-1, O-1, C-1, RF-1 display files
    *.json              Pacific Deterrence Initiative, Drug Interdiction

public/data/            GENERATED by scripts/process-jbook.js
  catalog.json          index of all documents for the dropdown menus
  <id>.json             one normalized document per source file

scripts/
  process-jbook.js      build-time parser (Node.js, ES module)

src/
  main.jsx              React entry point
  App.jsx               root component, owns all state
  colors.js             shared COLORS object
  components/
    Dropdowns.jsx       cascading Service → Appropriation → Document selectors
    Breadcrumb.jsx      navigation path display
    Charts.jsx          BudgetBarChart and BudgetTreemap (Recharts wrappers)
    BudgetViewer.jsx    grid navigator, chart panels, data table
```

---

## EAS JSON/XML Schema

EAS = Electronic Accounting System (used by Army, Air Force, Defense-Wide agencies).
Files have a consistent structure regardless of appropriation type.

### Root structure
```json
{
  "Metadata": { "BudgetYear": "2026", "Agency": "...", ... },
  "GeneratedOutput": { "Type": "Exhibit|Book|Book Section", "Name": "...", "Children": [...] }
}
```

### Node hierarchy
```
Book
└─ Book Section        (each has its own {Metadata, GeneratedOutput} wrapper)
   └─ Exhibit          (each has its own {Metadata, GeneratedOutput} wrapper)
      └─ Tab Strip      (direct Children[] — no GeneratedOutput wrapper)
         └─ Tab         (direct Children[])
            └─ Grid     (leaf node — has Columns[] and Rows[])
            └─ Toggle   (ignored — narrative text, no data)
```

### CRITICAL: Two child locations
Children arrays appear in one of two places depending on node type:
- **`node.Children`** — TabStrip, Tab, Grid (UI layout nodes)
- **`node.GeneratedOutput.Children`** — Book, Book Section, Exhibit (document nodes)

**Detection rule:** If a node has BOTH `Metadata` AND `GeneratedOutput` as siblings,
it is a "document entity wrapper" — unwrap to `node.GeneratedOutput` before reading.

### Column definition schema
```json
{
  "Code": "RowText",         ← the identifier (NOT "ColumnCode")
  "Text": "FY 2024\n Actuals",  ← display label (strip \n and collapse spaces)
  "Type": "text | numeric",
  "Order": 1.0,
  "Group": "",
  "Level": 0
}
```

### Row / Cell schema
```json
{
  "Code": "OUSDCCYBERCOM_Clie",
  "Type": "data | subtotal | total | blank",
  "Cells": [
    {
      "ColumnCode": "RowText",   ← references Column.Code
      "Type": "text | numeric",
      "Value": "CYBERCOM",       ← always a string; numbers have commas ("1,505,375")
      "NarrativeData": null
    }
  ]
}
```

**Dollar amounts are in THOUSANDS.** Parse with `String(val).replace(/,/g, '')` → float.

### Blank columns to skip
`Blnk1`, `Blnk2`, `Blnk3`, `AddRow` — these are visual spacers only.

---

## Fiscal Year Column Codes

| Code | Meaning |
|------|---------|
| `Py` / `FyPy` | FY2024 Actual (Prior Year) |
| `PyCyPricChan` | Price change FY24→25 |
| `PyCyProgChan` | Program change FY24→25 |
| `Cy` / `FyCy` | FY2025 Enacted (Current Year) |
| `CyBy1PricChan` | Price change FY25→26 |
| `CyBy1ProgChan` | Program change FY25→26 |
| `By1` / `FyBy1` / `FyBy1InThou` | FY2026 Budget Request |

**Label column** (row name): `RowText` (EAS), `AccoTitl`, `BudgActiTitl`, `BudgLineItemTitl`.

**Grid type detection:**
- Has `BudgActiTitl` + `FyBy1InThou` → funding detail grid
- Has `FyPy` + `FyCy` + `FyBy1` → summary grid
- Has `Py` + `Cy` + `By1` → standard change-analysis grid

---

## Excel Schema (DoD Summary files)

Flat tabular format — each sheet is a separate grid. Example from P-1 (Exhibit P-1 sheet):

| Col | Header | Notes |
|-----|--------|-------|
| A | Account | e.g. "2031A" |
| B | Account Title | e.g. "Aircraft Procurement, Army" |
| C | Organization | e.g. "A" (Army) |
| D | Budget Activity | e.g. "01" |
| E | Budget Activity Title | |
| F | Line Number | |
| G | BSA | Budget Sub-Activity code |
| H | Budget SubActivity (BSA) Title | |
| I | Budget Line Item | |
| J | Budget Line Item (BLI) Title | |
| K | Cost Type | |
| L | Cost Type Title | |
| M | Add/Non-Add | |
| N | FY 2024 Actuals Quantity | |
| O | FY 2024 Actuals Amount | **in thousands** |
| P | FY 2025 Enacted Quantity | |
| Q | FY 2025 Enacted Amount | **in thousands** |
| R | FY 2026 Disc Request Quantity | |
| S | FY 2026 Disc Request Amount | **in thousands** |
| T | FY 2026 Reconciliation Request Quantity | |
| U | FY 2026 Reconciliation Request Amount | **in thousands** |
| V | FY 2026 Total Quantity | |
| W | FY 2026 Total Amount | **in thousands** |
| X | Classification | e.g. "U" (Unclassified) |

Row 1: totals summary row. Row 2: headers. Rows 3+: data.

---

## Parser (scripts/process-jbook.js)

- **Input:** all files in `fy2026_budget/`
- **Output:** `public/data/catalog.json` + one `<id>.json` per document
- Runs as the `prebuild` npm script before every `vite build`
- Uses CommonJS `require('xlsx')` (not ES import) due to xlsx v0.18 module issues
- MAX_DATA_ROWS = 200 per grid to keep output files manageable
- `blank` row type is filtered out (spacing rows only)
- Dollar values stored as JS numbers (in thousands)
- Column `Text` field normalized: `\n` → space, multiple spaces collapsed

---

## Known Gaps / Future Work

1. **Army / Air Force data:** Servers return HTTP 403. Would need Selenium/browser automation
   or manual download. Parser already supports their EAS XML/JSON format.
2. **O-1 Summary JSON** (`O-1_Summary_(Part_1).json`): No grids found — may use a
   different schema or be a pure narrative document.
3. **BRAC XML** (`FY2026_BRAC_Overview.xml`): PDF-derived Tagged XML — no structured data.
4. **Drill-down:** Current implementation shows grids as tabs. Future: click a total row
   to load the detail exhibit for that sub-activity.
5. **Search:** Add a text search box to filter rows across all grids.

---

## Tech Stack

| Tool | Version | Purpose |
|------|---------|---------|
| React | 18 | UI framework (components, hooks, state) |
| Vite | 6 | Dev server and build tool |
| Recharts | 2 | Charts (BarChart, Treemap) |
| fast-xml-parser | 4 | Parse Army/AF XML files at build time |
| xlsx (SheetJS) | 0.18 | Parse DoD Summary Excel files at build time |

No CSS framework — all styling uses inline style objects and the shared `COLORS` object.
